<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flow Shop Scheduling Gantt Chart</title>
    <link rel="stylesheet" href="dhtmlxgantt.css" type="text/css">
    <script src="dhtmlxgantt.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #button-container {

            display: flex;

            justify-content: center;

            align-items: center;

            width: 100%;

            height: 50px; /* 设置一个高度 */

            background-color: #007bff; /* 背景颜色 */

            color: #fff; /* 文字颜色 */

            position: fixed; /* 固定在页面顶部 */

            top: 0; /* 顶部位置 */

            left: 0;

            z-index: 1000; /* 确保在gantt图上方 */

        }



        #button-container:hover {

            background-color: #0056b3; /* 鼠标悬停时的背景颜色 */

        }



        #toggleRenderButton {

            color: #fff; /* 文字颜色 */

            background: none; /* 无背景 */

            border: none; /* 无边框 */

            padding: 0; /* 无内边距 */

            font-size: 40px; /* 字体大小 */
            width: 100%;

            cursor: pointer; /* 鼠标指针 */

            text-transform: uppercase; /* 大小写字母 */

            letter-spacing: 0.05em; /* 字母间距 */

        }



        #gantt_here {

            width: 100%;

            height: calc(100vh - 50px);

            position: fixed; /* 修改为fixed定位 */

            top: 50px; /* 给gantt图顶部留出按钮的高度 */

            left: 0; /* 确保元素从视口的左侧开始 */

            overflow-y: auto; /* 如果内容超出，则显示垂直滚动条 */

        }

        .gantt_tree {

            text-align: left; /* 任务名称左对齐 */

        }



        .gantt_grid_data {

            text-align: center; /* 其他数值列居中对齐 */

        }

    </style>
</head>
<body>

<div id="button-container">

    <button id="toggleRenderButton">Scheduling Gantt Chart</button>

</div>



<div id="gantt_here" style=""></div>


<script>
    gantt.config.columns = [

        {name: "text", label: "Meachines", width: 130, tree: true}, // tree: true 以显示展开图标

        {name: "start_date", label: "Start Time", width: 80, template: gantt.formatDate},

        {name: "duration", label: "Duration", width: 70},

        {name: "use_rate", label: "Use Rate", width: 70},

        {name: "wait_rate", label: "Wait Rate", width:70},

        {name: "block_rate", label: "Block Rate", width:70},

    ];


    gantt.config.duration_unit = "minute"; // Set duration unit to seconds

    gantt.config.date_format = "%Y-%m-%d %H:%i:%s"; // 确保刻度和时间线上显示时分秒

    gantt.config.task_date_format = "%Y-%m-%d %H:%i:%s"; // 确保任务列表中显示时分秒

    gantt.config.date_scale = "%H:%i";
    gantt.config.scale_unit = "minute";

    gantt.config.scale_height = 40; // Set scale height for each machine

    gantt.config.row_height = 40; // Set row height for each task

    gantt.config.min_column_width = 35; // Minimum width for the columns

    //gantt.config.readonly = true;
    var meachine_ganttData = [[[1, 49.0, 76.0, 1], [7, 76.0, 117.0, 1], [20, 117.0, 154.0, 1], [16, 154.0, 236.0, 1], [13, 236.0, 310.0, 1], [10, 310.0, 378.0, 1], [18, 378.0, 472.0, 1]], [[17, 53.0, 77.0, 1], [9, 77.0, 142.0, 1], [6, 142.0, 213.0, 1], [14, 213.0, 278.0, 1], [19, 278.0, 331.0, 1], [12, 331.0, 402.0, 1], [3, 402.0, 457.0, 1]], [[15, 56.0, 147.0, 1], [2, 147.0, 183.0, 1], [8, 183.0, 258.0, 1], [11, 258.0, 318.0, 1], [4, 318.0, 363.0, 1], [5, 363.0, 456.0, 1]], [[1, 85.0, 98.0, 2], [9, 147.0, 222.0, 2], [6, 222.0, 281.0, 2], [14, 283.0, 351.0, 2], [19, 351.0, 391.0, 2], [10, 391.0, 423.0, 2], [3, 462.0, 523.0, 2]], [[17, 87.0, 174.0, 2], [15, 174.0, 251.0, 2], [8, 265.0, 334.0, 2], [11, 334.0, 366.0, 2], [4, 370.0, 456.0, 2], [18, 486.0, 527.0, 2]], [[7, 134.0, 189.0, 2], [20, 189.0, 213.0, 2], [2, 213.0, 246.0, 2], [16, 253.0, 321.0, 2], [13, 327.0, 411.0, 2], [12, 415.0, 422.0, 2], [5, 466.0, 520.0, 2]], [[1, 109.0, 192.0, 3], [20, 216.0, 239.0, 3], [9, 239.0, 250.0, 3], [2, 250.0, 345.0, 3], [14, 362.0, 458.0, 3], [5, 523.0, 553.0, 3]], [[17, 182.0, 255.0, 3], [6, 294.0, 337.0, 3], [16, 337.0, 382.0, 3], [11, 382.0, 404.0, 3], [19, 404.0, 410.0, 3], [13, 416.0, 448.0, 3], [4, 464.0, 516.0, 3], [18, 535.0, 542.0, 3]], [[7, 197.0, 253.0, 3], [15, 262.0, 337.0, 3], [8, 345.0, 424.0, 3], [12, 430.0, 432.0, 3], [10, 439.0, 462.0, 3], [3, 539.0, 566.0, 3]], [[1, 202.0, 295.0, 4], [17, 295.0, 344.0, 4], [15, 344.0, 410.0, 4], [11, 412.0, 440.0, 4], [8, 440.0, 481.0, 4], [14, 481.0, 551.0, 4], [18, 551.0, 583.0, 4]], [[20, 252.0, 285.0, 4], [7, 285.0, 359.0, 4], [2, 359.0, 377.0, 4], [16, 393.0, 467.0, 4], [13, 467.0, 530.0, 4], [4, 530.0, 574.0, 4], [3, 574.0, 581.0, 4]], [[9, 265.0, 330.0, 4], [6, 350.0, 438.0, 4], [19, 438.0, 462.0, 4], [12, 462.0, 489.0, 4], [10, 489.0, 574.0, 4], [5, 574.0, 578.0, 4]]];
    var agv_ganttData =[[[0, 0.0, 45.0, 13, 0], [1, 45.0, 49.0, 0, 1], [0, 49.0, 53.0, 1, 0], [14, 53.0, 61.0, 0, 2], [0, 72.0, 76.0, 2, 1], [1, 76.0, 85.0, 1, 4], [0, 108.0, 117.0, 4, 1], [7, 117.0, 134.0, 1, 6], [0, 137.0, 147.0, 6, 3], [15, 147.0, 154.0, 3, 5], [0, 176.0, 183.0, 5, 3], [2, 183.0, 193.0, 3, 6], [0, 200.0, 213.0, 6, 2], [6, 213.0, 218.0, 2, 4], [0, 227.0, 236.0, 4, 1], [16, 236.0, 253.0, 1, 6], [0, 265.0, 278.0, 6, 2], [14, 278.0, 283.0, 2, 4], [0, 301.0, 310.0, 4, 1], [13, 310.0, 327.0, 1, 6], [0, 353.0, 363.0, 6, 3], [4, 363.0, 370.0, 3, 5], [0, 392.0, 402.0, 5, 2], [12, 402.0, 415.0, 2, 6], [0, 446.0, 456.0, 6, 3], [5, 456.0, 466.0, 3, 6], [0, 520.0, 520.0, 6, 6], [5, 520.0, 523.0, 6, 7], [0, 540.0, 542.0, 7, 8], [18, 542.0, 550.0, 8, 10], [0, 561.0, 566.0, 10, 9], [3, 566.0, 574.0, 9, 11]], [[0, 0.0, 45.0, 13, 0], [17, 45.0, 53.0, 0, 2], [0, 53.0, 61.0, 2, 0], [10, 61.0, 65.0, 0, 1], [0, 73.0, 77.0, 1, 2], [17, 77.0, 87.0, 2, 5], [0, 132.0, 142.0, 5, 2], [9, 142.0, 147.0, 2, 4], [0, 256.0, 258.0, 4, 3], [8, 258.0, 265.0, 3, 5], [0, 311.0, 318.0, 5, 3], [11, 318.0, 325.0, 3, 5], [0, 364.0, 378.0, 5, 1], [10, 378.0, 387.0, 1, 4], [0, 452.0, 457.0, 4, 2], [3, 457.0, 462.0, 2, 4], [0, 463.0, 472.0, 4, 1], [18, 472.0, 486.0, 1, 5], [0, 518.0, 523.0, 5, 4], [3, 523.0, 539.0, 4, 9], [0, 548.0, 553.0, 9, 7], [5, 553.0, 568.0, 7, 12]], [[0, 0.0, 45.0, 13, 0], [15, 45.0, 56.0, 0, 3], [0, 56.0, 67.0, 3, 0], [18, 67.0, 71.0, 0, 1], [0, 154.0, 154.0, 1, 1], [20, 154.0, 171.0, 1, 6], [0, 318.0, 331.0, 6, 2], [19, 331.0, 336.0, 2, 4], [0, 351.0, 351.0, 4, 4], [14, 351.0, 362.0, 4, 7], [0, 380.0, 391.0, 7, 4], [19, 391.0, 404.0, 4, 8], [0, 406.0, 411.0, 8, 6], [13, 411.0, 416.0, 6, 8], [0, 417.0, 422.0, 8, 6], [12, 422.0, 430.0, 6, 9], [0, 445.0, 456.0, 9, 5], [4, 456.0, 464.0, 5, 8], [0, 519.0, 527.0, 8, 5], [18, 527.0, 535.0, 5, 8]], [[0, 0.0, 45.0, 13, 0], [7, 45.0, 49.0, 0, 1], [0, 49.0, 53.0, 1, 0], [13, 53.0, 57.0, 0, 1], [0, 57.0, 61.0, 1, 0], [4, 61.0, 72.0, 0, 3], [0, 96.0, 98.0, 3, 4], [1, 98.0, 109.0, 4, 7], [0, 168.0, 174.0, 7, 5], [17, 174.0, 182.0, 5, 8], [0, 184.0, 189.0, 8, 6], [7, 189.0, 197.0, 6, 9], [0, 205.0, 213.0, 9, 6], [20, 213.0, 216.0, 6, 7], [0, 243.0, 246.0, 7, 6], [2, 246.0, 249.0, 6, 7], [0, 270.0, 281.0, 7, 4], [6, 281.0, 294.0, 4, 8], [0, 316.0, 321.0, 8, 6], [16, 321.0, 326.0, 6, 8], [0, 326.0, 334.0, 8, 5], [8, 334.0, 345.0, 5, 9], [0, 355.0, 366.0, 9, 5], [11, 366.0, 374.0, 5, 8], [0, 410.0, 423.0, 8, 4], [10, 423.0, 439.0, 4, 9], [0, 445.0, 448.0, 9, 8], [13, 448.0, 459.0, 8, 11], [0, 505.0, 516.0, 11, 8], [4, 516.0, 527.0, 8, 11]], [[0, 0.0, 45.0, 13, 0], [9, 45.0, 53.0, 0, 2], [0, 53.0, 61.0, 2, 0], [12, 61.0, 69.0, 0, 2], [0, 217.0, 222.0, 2, 4], [9, 222.0, 233.0, 4, 7], [0, 245.0, 251.0, 7, 5], [15, 251.0, 262.0, 5, 9], [0, 334.0, 337.0, 9, 8], [6, 337.0, 350.0, 8, 12], [0, 369.0, 382.0, 12, 8], [16, 382.0, 393.0, 8, 11], [0, 393.0, 404.0, 11, 8], [11, 404.0, 412.0, 8, 10], [0, 419.0, 424.0, 10, 9], [8, 424.0, 429.0, 9, 10], [0, 448.0, 458.0, 10, 7], [14, 458.0, 468.0, 7, 10]], [[0, 0.0, 45.0, 13, 0], [20, 45.0, 49.0, 0, 1], [0, 49.0, 53.0, 1, 0], [11, 53.0, 64.0, 0, 3], [0, 179.0, 192.0, 3, 7], [1, 192.0, 202.0, 7, 10], [0, 229.0, 239.0, 10, 7], [20, 239.0, 252.0, 7, 11], [0, 329.0, 337.0, 11, 9], [15, 337.0, 342.0, 9, 10], [0, 402.0, 410.0, 10, 8], [19, 410.0, 423.0, 8, 12], [0, 452.0, 462.0, 12, 9], [10, 462.0, 472.0, 9, 12]], [[0, 0.0, 45.0, 13, 0], [6, 45.0, 53.0, 0, 2], [0, 53.0, 61.0, 2, 0], [5, 61.0, 72.0, 0, 3], [0, 237.0, 250.0, 3, 7], [9, 250.0, 265.0, 7, 12], [0, 330.0, 345.0, 12, 7], [2, 345.0, 358.0, 7, 11], [0, 424.0, 432.0, 11, 9], [12, 432.0, 442.0, 9, 12]], [[0, 0.0, 45.0, 13, 0], [2, 45.0, 56.0, 0, 3], [0, 56.0, 67.0, 3, 0], [3, 67.0, 75.0, 0, 2], [0, 232.0, 253.0, 2, 9], [7, 253.0, 261.0, 9, 11]], [[0, 0.0, 45.0, 13, 0], [16, 45.0, 49.0, 0, 1], [0, 49.0, 53.0, 1, 0], [19, 53.0, 61.0, 0, 2], [0, 237.0, 255.0, 2, 8], [17, 255.0, 263.0, 8, 10]], [[0, 0.0, 45.0, 13, 0], [8, 45.0, 56.0, 0, 3]]];
    var wait_rate =[0.0, 0.0, 0.0, 0.2054794520547945, 0.10909090909090909, 0.15803108808290156, 0.23873873873873874, 0.2222222222222222, 0.2899728997289973, 0.005249343832020997, 0.0486322188449848, 0.06389776357827476];
    var block_rate =[0.7777777777777778, 0.8638613861386139, 0.7675, 0.05251141552511415, 0.0659090909090909, 0.09844559585492228, 0.015765765765765764, 0.05277777777777778, 0.0, 0.15485564304461943, 0.1094224924012158, 0.1853035143769968];
    var agv_block_rate =[0.08536585365853659, 0.09330985915492958, 0.10467289719626169, 0.10815939278937381, 0.11324786324786325, 0.1038135593220339, 0.11990950226244344, 0.21455938697318008, 0.18631178707224336, 0.0];

    var colors = ["#15b01a", "#0343df", "#e50000", "#f97306", "#653700", "#929591", "#00ffff", "#6e750e",

        "#a03623", "#fac205", "#bf9005", "#029386", "#214761", "#ffd1df", "#e6daa6"];


    gantt.init("gantt_here");
    // 定义一个函数来切换render属性

    function toggleRender(m_index) {

        var taskId = m_index;

        var task = gantt.getTask(taskId);

        if (task) {

            task.render = task.render === 'split' ? 'box' : 'split';

            gantt.updateTask(taskId);

        }

    }



    // 给按钮添加点击事件监听器

    document.getElementById("toggleRenderButton").addEventListener("click", function() {

        // 假设你想要切换的任务索引是1（例如，"M1"）
        for (var m = 0; m < meachine_ganttData.length+agv_ganttData.length; m++) {
            toggleRender(m+1);
        }

// 重新计算甘特图的尺寸
        gantt.resize();
        // 滚动到甘特图的顶部
        gantt.scrollTo(0);

    });


    gantt.parse({

        data: (function () {

            var tasks = [];

            var taskIndex = 1;

            for (var m = 0; m < meachine_ganttData.length; m++) { // Iterate over machines
                var end_job = meachine_ganttData[m][meachine_ganttData[m].length - 1];
                var star_job = meachine_ganttData[m][0];
                var dur_time = end_job[2] - star_job[1]
                var m_index = m + 1

                var startDate = new Date(); // 获取当前日期和时间
                //var startDate = new Date();

                var startDays = star_job[1]; // 假设 job[1] 是要添加的天数
                function addDays(startDate, days) {

                    var result = new Date(startDate);

                    result.setDate(result.getDate() + days);
                    console.log(result)

                    return result;

                }
                function addMinutes(startDate, minutes) {

                    var result = new Date(startDate);



                    result.setMinutes(result.getMinutes() + minutes);

                    console.log(result);



                    return result;

                }

                var newStartDate = addMinutes(startDate, startDays);
                var wait=100*wait_rate[m]
                var block=100*block_rate[m]
                tasks.push({

                    id: taskIndex,

                    text: "M" + m_index,

                    start_date: newStartDate,//job[1],

                    duration: dur_time, // Convert days to seconds

                    parent: 0,

                    progress: 0.0,
                    wait_rate:wait.toFixed(2) + '%',
                    block_rate:block.toFixed(2) + '%',

                    open: false,
                    render: 'split',

                    color: '#007bff'// Job color

                });
                taskIndex++

            }

            for (var m = 0; m < agv_ganttData.length; m++) { // Iterate over machines
                var end_job = agv_ganttData[m][agv_ganttData[m].length - 1];
                var star_job = agv_ganttData[m][0];
                var dur_time = end_job[2] - star_job[1]
                var m_index = m + 1
                var block=100*agv_block_rate[m]
                var startDate = new Date(); // 获取当前日期和时间
                //var startDate = new Date();

                var startDays = star_job[1]; // 假设 job[1] 是要添加的天数
                function addDays(startDate, days) {

                    var result = new Date(startDate);

                    result.setDate(result.getDate() + days);
                    console.log(result)

                    return result;

                }
                function addMinutes(startDate, minutes) {

                    var result = new Date(startDate);



                    result.setMinutes(result.getMinutes() + minutes);

                    console.log(result);



                    return result;

                }

                var newStartDate = addMinutes(startDate, startDays);
                tasks.push({

                    id: taskIndex,

                    text: "AGV" + m_index,

                    start_date: newStartDate,//job[1],

                    duration: dur_time, // Convert days to seconds

                    parent: 0,
                    block_rate:block.toFixed(2) + '%',
                    progress: 0.0,

                    open: false,
                    render: 'split',

                    color: '#007bff'// Job color

                });
                taskIndex++

            }






            for (var m = 0; m < meachine_ganttData.length; m++) { // Iterate over machines
                var total_time=  meachine_ganttData[m][meachine_ganttData[m].length - 1][2]-meachine_ganttData[m][0][1];
                var use_time=0;

                for (var j = 0; j < meachine_ganttData[m].length; j++) { // Iterate over jobs

                    var job = meachine_ganttData[m][j];
                    use_time+=(job[2]-job[1]);

                    // 假设 startDate 是一个 Date 对象，days 是要添加的天数

                    function addDays(startDate, days) {

                        var result = new Date(startDate);

                        result.setDate(result.getDate() + days);
                        console.log(result)

                        return result;

                    }
                    function addMinutes(startDate, minutes) {

                        var result = new Date(startDate);



                        result.setMinutes(result.getMinutes() + minutes);

                        console.log(result);



                        return result;

                    }


// 使用示例

                    var startDate = new Date();

                    var jobDays = job[1]; // 假设 job[1] 是要添加的天数

                    var newStartDate = addMinutes(startDate, jobDays);


// 然后将 newStartDate 用作任务的开始日期
                    var op = "|T" + job[3] + '|'

                    tasks.push({

                        id: taskIndex++,

                        text: "J" + job[0] + op,

                        start_date: newStartDate,

                        duration: job[2] - job[1],

                        parent: m + 1,

                        progress: 0.0,

                        open: false,

                        color: colors[(job[0] - 1) % colors.length]

                    });

                }
                var task=tasks[m]

                if (task) {

                    if (total_time !== 0) {

                        // 计算 use_rate 并保留两位小数

                        task.use_rate = (use_time / total_time * 100).toFixed(2) + '%';

                    } else {

                        // 如果 total_time 为 0，可以设置 use_rate 为 0% 或其他默认值

                        task.use_rate = '0%';

                    }

                }

            }



            for (var m = 0; m < agv_ganttData.length; m++) { // Iterate over machines
                var total_time=  agv_ganttData[m][agv_ganttData[m].length - 1][2]-agv_ganttData[m][0][1];
                var use_time=0;

                for (var j = 0; j < agv_ganttData[m].length; j++) { // Iterate over jobs

                    var job = agv_ganttData[m][j];
                    use_time+=(job[2]-job[1])

                    // 假设 startDate 是一个 Date 对象，days 是要添加的天数

                    function addDays(startDate, days) {

                        var result = new Date(startDate);

                        result.setDate(result.getDate() + days);
                        console.log(result)

                        return result;

                    }
                    function addMinutes(startDate, minutes) {

                        var result = new Date(startDate);



                        result.setMinutes(result.getMinutes() + minutes);

                        console.log(result);



                        return result;

                    }


// 使用示例

                    var startDate = new Date();

                    var jobDays = job[1]; // 假设 job[1] 是要添加的天数

                    var newStartDate = addMinutes(startDate, jobDays);


// 然后将 newStartDate 用作任务的开始日期
                    var from_to = "|F" + job[3] + '|T'+job[4]+'|'
                    tasks.push({

                        id: taskIndex++,

                        text: "J" + job[0] + from_to,

                        start_date: newStartDate,

                        duration: job[2] - job[1],

                        parent: meachine_ganttData.length+m + 1,

                        progress: 0.0,

                        open: false,

                        color: colors[(job[0] - 1) % colors.length]

                    });

                }

                var task=tasks[meachine_ganttData.length+m]

                if (task) {

                    if (total_time !== 0) {

                        // 计算 use_rate 并保留两位小数

                        task.use_rate = (use_time / total_time * 100).toFixed(2) + '%';
                        task.wait_rate= ((1-use_time / total_time) * 100).toFixed(2) + '%';

                    } else {

                        // 如果 total_time 为 0，可以设置 use_rate 为 0% 或其他默认值

                        task.use_rate = '0%';
                        task.wait_rate='0%';


                    }

                }

            }



            return tasks;

        })(),

        links: []

    });


    // Set date format
    //gantt.config.start_date = this.nowDate.format('YYYY-MM-DD')
    //gantt.config.end_date = this.newDate.format('YYYY-MM-DD')

    //    gantt.config.date_format = "%Y-%m-%d %H:%i:%s"; // Include seconds in date format
    //gantt.resize();


    // Adjust the view

    gantt.attachEvent("onGanttReady", function () {

        gantt.showDate(gantt.date.add(gantt.date.min, gantt.date.day, 1));

        gantt.showDate(gantt.date.add(gantt.date.max, gantt.date.day, 10));

    });

</script>

</body>
</html>
