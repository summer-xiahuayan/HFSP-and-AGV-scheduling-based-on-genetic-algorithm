<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flow Shop Scheduling Gantt Chart</title>
    <link rel="stylesheet" href="dhtmlxgantt.css" type="text/css">
    <script src="dhtmlxgantt.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #button-container {

            display: flex;

            justify-content: center;

            align-items: center;

            width: 100%;

            height: 50px; /* 设置一个高度 */

            background-color: #007bff; /* 背景颜色 */

            color: #fff; /* 文字颜色 */

            position: fixed; /* 固定在页面顶部 */

            top: 0; /* 顶部位置 */

            left: 0;

            z-index: 1000; /* 确保在gantt图上方 */

        }



        #button-container:hover {

            background-color: #0056b3; /* 鼠标悬停时的背景颜色 */

        }



        #toggleRenderButton {

            color: #fff; /* 文字颜色 */

            background: none; /* 无背景 */

            border: none; /* 无边框 */

            padding: 0; /* 无内边距 */

            font-size: 40px; /* 字体大小 */
            width: 100%;

            cursor: pointer; /* 鼠标指针 */

            text-transform: uppercase; /* 大小写字母 */

            letter-spacing: 0.05em; /* 字母间距 */

        }



        #gantt_here {

            width: 100%;

            height: calc(100vh - 50px);

            position: fixed; /* 修改为fixed定位 */

            top: 50px; /* 给gantt图顶部留出按钮的高度 */

            left: 0; /* 确保元素从视口的左侧开始 */

            overflow-y: auto; /* 如果内容超出，则显示垂直滚动条 */

        }

        .gantt_tree {

            text-align: left; /* 任务名称左对齐 */

        }



        .gantt_grid_data {

            text-align: center; /* 其他数值列居中对齐 */

        }


        .gantt_task_content {

            font-weight: bold !important;

            font-size: 13px;

        }


    </style>
</head>
<body>

<div id="button-container">

    <button id="toggleRenderButton">Scheduling Gantt Chart</button>

</div>



<div id="gantt_here" style=""></div>


<script>
    gantt.config.columns = [

        {name: "text", label: "Meachines", width: 130, tree: true}, // tree: true 以显示展开图标

        {name: "start_date", label: "Start Time", width: 80, template: gantt.formatDate},

        {name: "duration", label: "Duration", width: 70},

        {name: "use_rate", label: "Use Rate", width: 70},

        {name: "wait_rate", label: "Wait Rate", width:70},

        {name: "block_rate", label: "Block Rate", width:70},

    ];


    gantt.config.duration_unit = "minute"; // Set duration unit to seconds

    gantt.config.date_format = "%Y-%m-%d %H:%i:%s"; // 确保刻度和时间线上显示时分秒

    gantt.config.task_date_format = "%Y-%m-%d %H:%i:%s"; // 确保任务列表中显示时分秒

    gantt.config.date_scale = "%H:%i";
    gantt.config.scale_unit = "minute";

    gantt.config.scale_height = 40; // Set scale height for each machine

    gantt.config.row_height = 40; // Set row height for each task

    gantt.config.min_column_width = 35; // Minimum width for the columns

    //gantt.config.readonly = true;
    var meachine_ganttData = [[[1, 48.0, 75.0, 1], [12, 75.0, 146.0, 1], [4, 146.0, 191.0, 1], [17, 191.0, 215.0, 1], [16, 215.0, 297.0, 1], [14, 297.0, 362.0, 1], [5, 362.0, 455.0, 1]], [[15, 50.0, 141.0, 1], [10, 141.0, 209.0, 1], [18, 209.0, 303.0, 1], [13, 303.0, 377.0, 1], [9, 377.0, 442.0, 1]], [[11, 53.0, 113.0, 1], [20, 113.0, 150.0, 1], [6, 150.0, 221.0, 1], [19, 221.0, 274.0, 1], [7, 274.0, 315.0, 1], [8, 315.0, 390.0, 1], [2, 390.0, 426.0, 1], [3, 426.0, 481.0, 1]], [[1, 121.0, 134.0, 2], [15, 146.0, 223.0, 2], [10, 223.0, 255.0, 2], [17, 255.0, 342.0, 2], [19, 342.0, 382.0, 2], [18, 382.0, 423.0, 2], [14, 423.0, 491.0, 2], [8, 491.0, 560.0, 2], [9, 560.0, 635.0, 2], [3, 635.0, 696.0, 2]], [[11, 117.0, 149.0, 2], [12, 155.0, 162.0, 2], [20, 162.0, 186.0, 2], [4, 200.0, 286.0, 2], [6, 286.0, 345.0, 2], [16, 345.0, 413.0, 2], [7, 413.0, 468.0, 2], [13, 468.0, 552.0, 2], [2, 552.0, 585.0, 2], [5, 585.0, 639.0, 2]], [[1, 139.0, 222.0, 3], [10, 260.0, 283.0, 3], [17, 347.0, 420.0, 3], [7, 471.0, 527.0, 3], [8, 565.0, 644.0, 3], [5, 644.0, 674.0, 3]], [[11, 157.0, 179.0, 3], [15, 233.0, 308.0, 3], [6, 353.0, 396.0, 3], [16, 421.0, 466.0, 3], [13, 560.0, 592.0, 3], [2, 593.0, 688.0, 3]], [[12, 176.0, 178.0, 3], [20, 200.0, 223.0, 3], [4, 300.0, 352.0, 3], [19, 398.0, 404.0, 3], [18, 439.0, 446.0, 3], [14, 507.0, 603.0, 3], [9, 651.0, 662.0, 3], [3, 712.0, 739.0, 3]], [[12, 183.0, 210.0, 4], [1, 241.0, 334.0, 4], [15, 334.0, 400.0, 4], [6, 407.0, 495.0, 4], [18, 495.0, 527.0, 4], [7, 543.0, 617.0, 4], [14, 617.0, 687.0, 4], [9, 687.0, 752.0, 4]], [[11, 207.0, 235.0, 4], [20, 253.0, 286.0, 4], [10, 301.0, 386.0, 4], [4, 386.0, 430.0, 4], [19, 430.0, 454.0, 4], [17, 455.0, 504.0, 4], [16, 504.0, 578.0, 4], [13, 605.0, 668.0, 4], [8, 668.0, 709.0, 4], [5, 709.0, 713.0, 4], [2, 713.0, 731.0, 4], [3, 746.0, 753.0, 4]]];
    var agv_ganttData =[[[0, 0.0, 42.0, 11, 0], [1, 42.0, 48.0, 0, 1], [0, 48.0, 54.0, 1, 0], [20, 54.0, 65.0, 0, 3], [0, 65.0, 76.0, 3, 0], [16, 76.0, 82.0, 0, 1], [0, 82.0, 88.0, 1, 0], [13, 88.0, 96.0, 0, 2], [0, 96.0, 104.0, 2, 0], [5, 104.0, 110.0, 0, 1], [0, 110.0, 116.0, 1, 0], [3, 116.0, 127.0, 0, 3], [0, 138.0, 141.0, 3, 2], [15, 141.0, 146.0, 2, 4], [0, 148.0, 150.0, 4, 3], [20, 150.0, 154.0, 3, 5], [0, 182.0, 191.0, 5, 1], [4, 191.0, 200.0, 1, 5], [0, 202.0, 209.0, 5, 2], [10, 209.0, 214.0, 2, 4], [0, 219.0, 221.0, 4, 3], [6, 221.0, 225.0, 3, 5], [0, 270.0, 274.0, 5, 3], [19, 274.0, 276.0, 3, 4], [0, 290.0, 297.0, 4, 1], [16, 297.0, 306.0, 1, 5], [0, 311.0, 315.0, 5, 3], [7, 315.0, 319.0, 3, 5], [0, 353.0, 362.0, 5, 1], [14, 362.0, 369.0, 1, 4], [0, 372.0, 377.0, 4, 2], [13, 377.0, 384.0, 2, 5], [0, 386.0, 390.0, 5, 3], [8, 390.0, 392.0, 3, 4], [0, 424.0, 426.0, 4, 3], [2, 426.0, 430.0, 3, 5], [0, 435.0, 442.0, 5, 2], [9, 442.0, 447.0, 2, 4], [0, 448.0, 455.0, 4, 1], [5, 455.0, 464.0, 1, 5], [0, 477.0, 481.0, 5, 3], [3, 481.0, 483.0, 3, 4], [0, 491.0, 491.0, 4, 4], [14, 491.0, 507.0, 4, 8], [0, 538.0, 552.0, 8, 5], [13, 552.0, 560.0, 5, 7], [0, 577.0, 585.0, 7, 5], [2, 585.0, 593.0, 5, 7], [0, 625.0, 635.0, 7, 4], [9, 635.0, 651.0, 4, 8], [0, 680.0, 696.0, 8, 4], [3, 696.0, 712.0, 4, 8], [0, 739.0, 739.0, 8, 8], [3, 739.0, 746.0, 8, 10]], [[0, 0.0, 42.0, 11, 0], [15, 42.0, 50.0, 0, 2], [0, 50.0, 58.0, 2, 0], [4, 58.0, 64.0, 0, 1], [0, 64.0, 70.0, 1, 0], [17, 70.0, 76.0, 0, 1], [0, 76.0, 82.0, 1, 0], [19, 82.0, 93.0, 0, 3], [0, 93.0, 104.0, 3, 0], [9, 104.0, 112.0, 0, 2], [0, 112.0, 114.0, 2, 1], [1, 114.0, 121.0, 1, 4], [0, 139.0, 146.0, 4, 1], [12, 146.0, 155.0, 1, 5], [0, 206.0, 215.0, 5, 1], [17, 215.0, 222.0, 1, 4], [0, 298.0, 303.0, 4, 2], [18, 303.0, 308.0, 2, 4], [0, 342.0, 342.0, 4, 4], [17, 342.0, 347.0, 4, 6], [0, 377.0, 382.0, 6, 4], [19, 382.0, 398.0, 4, 8], [0, 399.0, 413.0, 8, 5], [16, 413.0, 421.0, 5, 7], [0, 460.0, 468.0, 7, 5], [7, 468.0, 471.0, 5, 6], [0, 555.0, 560.0, 6, 4], [8, 560.0, 565.0, 4, 6], [0, 636.0, 639.0, 6, 5], [5, 639.0, 642.0, 5, 6], [0, 644.0, 644.0, 6, 6], [8, 644.0, 662.0, 6, 10], [0, 675.0, 688.0, 10, 7], [2, 688.0, 701.0, 7, 10]], [[0, 0.0, 42.0, 11, 0], [11, 42.0, 53.0, 0, 3], [0, 53.0, 64.0, 3, 0], [6, 64.0, 75.0, 0, 3], [0, 75.0, 86.0, 3, 0], [7, 86.0, 97.0, 0, 3], [0, 97.0, 108.0, 3, 0], [2, 108.0, 119.0, 0, 3], [0, 132.0, 134.0, 3, 4], [1, 134.0, 139.0, 4, 6], [0, 146.0, 149.0, 6, 5], [11, 149.0, 157.0, 5, 7], [0, 178.0, 186.0, 7, 5], [20, 186.0, 200.0, 5, 8], [0, 207.0, 223.0, 8, 4], [15, 223.0, 233.0, 4, 7], [0, 245.0, 255.0, 7, 4], [10, 255.0, 260.0, 4, 6], [0, 283.0, 286.0, 6, 5], [4, 286.0, 300.0, 5, 8], [0, 331.0, 345.0, 8, 5], [6, 345.0, 353.0, 5, 7], [0, 413.0, 423.0, 7, 4], [18, 423.0, 439.0, 4, 8], [0, 446.0, 446.0, 8, 8], [18, 446.0, 451.0, 8, 9], [0, 455.0, 466.0, 9, 7], [16, 466.0, 479.0, 7, 10], [0, 509.0, 527.0, 10, 6], [7, 527.0, 543.0, 6, 9], [0, 581.0, 592.0, 9, 7], [13, 592.0, 605.0, 7, 10], [0, 655.0, 662.0, 10, 8], [9, 662.0, 667.0, 8, 9]], [[0, 0.0, 42.0, 11, 0], [12, 42.0, 48.0, 0, 1], [0, 48.0, 54.0, 1, 0], [10, 54.0, 62.0, 0, 2], [0, 62.0, 70.0, 2, 0], [18, 70.0, 78.0, 0, 2], [0, 78.0, 86.0, 2, 0], [14, 86.0, 92.0, 0, 1], [0, 92.0, 98.0, 1, 0], [8, 98.0, 109.0, 0, 3], [0, 113.0, 113.0, 3, 3], [11, 113.0, 117.0, 3, 5], [0, 162.0, 162.0, 5, 5], [12, 162.0, 176.0, 5, 8], [0, 178.0, 178.0, 8, 8], [12, 178.0, 183.0, 8, 9], [0, 183.0, 194.0, 9, 7], [11, 194.0, 207.0, 7, 10], [0, 207.0, 225.0, 10, 6], [1, 225.0, 241.0, 6, 9], [0, 241.0, 246.0, 9, 8], [20, 246.0, 253.0, 8, 10], [0, 265.0, 283.0, 10, 6], [10, 283.0, 301.0, 6, 10], [0, 301.0, 314.0, 10, 7], [15, 314.0, 325.0, 7, 9], [0, 347.0, 352.0, 9, 8], [4, 352.0, 359.0, 8, 10], [0, 383.0, 396.0, 10, 7], [6, 396.0, 407.0, 7, 9], [0, 407.0, 412.0, 9, 8], [19, 412.0, 419.0, 8, 10], [0, 419.0, 437.0, 10, 6], [17, 437.0, 455.0, 6, 10], [0, 596.0, 603.0, 10, 8], [14, 603.0, 608.0, 8, 9], [0, 658.0, 674.0, 9, 6], [5, 674.0, 692.0, 6, 10]]];
    var wait_rate =[0.0, 0.0, 0.0, 0.020869565217391306, 0.038314176245210725, 0.35700934579439253, 0.4124293785310734, 0.6021314387211367, 0.09490333919156414, 0.1391941391941392];
    var block_rate =[0.7714987714987716, 0.8035714285714286, 0.8434579439252337, 0.6956521739130435, 0.6666666666666666, 0.003738317757009346, 0.0, 0.0, 0.14411247803163443, 0.16483516483516483];
    var agv_block_rate =[0.14745308310991956, 0.15977175463623394, 0.1454272863568216, 0.16907514450867053];

    var colors = ["#15b01a", "#0343df", "#e50000", "#f97306", "#653700", "#929591", "#00ffff", "#6e750e",

        "#a03623", "#fac205", "#bf9005", "#029386", "#214761", "#ffd1df", "#e6daa6"];


    gantt.init("gantt_here");
    // 定义一个函数来切换render属性

    function toggleRender(m_index) {

        var taskId = m_index;

        var task = gantt.getTask(taskId);

        if (task) {

            task.render = task.render === 'split' ? 'box' : 'split';

            gantt.updateTask(taskId);

        }

    }



    // 给按钮添加点击事件监听器

    document.getElementById("toggleRenderButton").addEventListener("click", function() {

        // 假设你想要切换的任务索引是1（例如，"M1"）
        for (var m = 0; m < meachine_ganttData.length+agv_ganttData.length; m++) {
            toggleRender(m+1);
        }

// 重新计算甘特图的尺寸
        gantt.resize();
        // 滚动到甘特图的顶部
        gantt.scrollTo(0);

    });


    gantt.parse({

        data: (function () {

            var tasks = [];

            var taskIndex = 1;

            for (var m = 0; m < meachine_ganttData.length; m++) { // Iterate over machines
                var end_job = meachine_ganttData[m][meachine_ganttData[m].length - 1];
                var star_job = meachine_ganttData[m][0];
                var dur_time = end_job[2] - star_job[1]
                var m_index = m + 1

                var startDate = new Date(); // 获取当前日期和时间
                //var startDate = new Date();

                var startDays = star_job[1]; // 假设 job[1] 是要添加的天数
                function addDays(startDate, days) {

                    var result = new Date(startDate);

                    result.setDate(result.getDate() + days);
                    console.log(result)

                    return result;

                }
                function addMinutes(startDate, minutes) {

                    var result = new Date(startDate);



                    result.setMinutes(result.getMinutes() + minutes);

                    console.log(result);



                    return result;

                }

                var newStartDate = addMinutes(startDate, startDays);
                var wait=100*wait_rate[m]
                var block=100*block_rate[m]
                tasks.push({

                    id: taskIndex,

                    text: "M" + m_index,

                    start_date: newStartDate,//job[1],

                    duration: dur_time, // Convert days to seconds

                    parent: 0,

                    progress: 0.0,
                    wait_rate:wait.toFixed(2) + '%',
                    block_rate:block.toFixed(2) + '%',

                    open: false,
                    render: 'split',

                    color: '#007bff'// Job color

                });
                taskIndex++

            }

            for (var m = 0; m < agv_ganttData.length; m++) { // Iterate over machines
                var end_job = agv_ganttData[m][agv_ganttData[m].length - 1];
                var star_job = agv_ganttData[m][0];
                var dur_time = end_job[2] - star_job[1]
                var m_index = m + 1
                var block=100*agv_block_rate[m]
                var startDate = new Date(); // 获取当前日期和时间
                //var startDate = new Date();

                var startDays = star_job[1]; // 假设 job[1] 是要添加的天数
                function addDays(startDate, days) {

                    var result = new Date(startDate);

                    result.setDate(result.getDate() + days);
                    console.log(result)

                    return result;

                }
                function addMinutes(startDate, minutes) {

                    var result = new Date(startDate);



                    result.setMinutes(result.getMinutes() + minutes);

                    console.log(result);



                    return result;

                }

                var newStartDate = addMinutes(startDate, startDays);
                tasks.push({

                    id: taskIndex,

                    text: "AGV" + m_index,

                    start_date: newStartDate,//job[1],

                    duration: dur_time, // Convert days to seconds

                    parent: 0,
                    block_rate:block.toFixed(2) + '%',
                    progress: 0.0,

                    open: false,
                    render: 'split',

                    color: '#007bff'// Job color

                });
                taskIndex++

            }






            for (var m = 0; m < meachine_ganttData.length; m++) { // Iterate over machines
                var total_time=  meachine_ganttData[m][meachine_ganttData[m].length - 1][2]-meachine_ganttData[m][0][1];
                var use_time=0;

                for (var j = 0; j < meachine_ganttData[m].length; j++) { // Iterate over jobs

                    var job = meachine_ganttData[m][j];
                    use_time+=(job[2]-job[1]);

                    // 假设 startDate 是一个 Date 对象，days 是要添加的天数

                    function addDays(startDate, days) {

                        var result = new Date(startDate);

                        result.setDate(result.getDate() + days);
                        console.log(result)

                        return result;

                    }
                    function addMinutes(startDate, minutes) {

                        var result = new Date(startDate);



                        result.setMinutes(result.getMinutes() + minutes);

                        console.log(result);



                        return result;

                    }


// 使用示例

                    var startDate = new Date();

                    var jobDays = job[1]; // 假设 job[1] 是要添加的天数

                    var newStartDate = addMinutes(startDate, jobDays);


// 然后将 newStartDate 用作任务的开始日期
                    var op = "|T" + job[3] + '|'

                    tasks.push({

                        id: taskIndex++,

                        text: "J" + job[0] + op,

                        start_date: newStartDate,

                        duration: job[2] - job[1],

                        parent: m + 1,

                        progress: 0.0,

                        open: false,

                        color: colors[(job[0] - 1) % colors.length]

                    });

                }
                var task=tasks[m]

                if (task) {

                    if (total_time !== 0) {

                        // 计算 use_rate 并保留两位小数

                        task.use_rate = (use_time / total_time * 100).toFixed(2) + '%';

                    } else {

                        // 如果 total_time 为 0，可以设置 use_rate 为 0% 或其他默认值

                        task.use_rate = '0%';

                    }

                }

            }



            for (var m = 0; m < agv_ganttData.length; m++) { // Iterate over machines
                var total_time=  agv_ganttData[m][agv_ganttData[m].length - 1][2]-agv_ganttData[m][0][1];
                var use_time=0;

                for (var j = 0; j < agv_ganttData[m].length; j++) { // Iterate over jobs

                    var job = agv_ganttData[m][j];
                    use_time+=(job[2]-job[1])

                    // 假设 startDate 是一个 Date 对象，days 是要添加的天数

                    function addDays(startDate, days) {

                        var result = new Date(startDate);

                        result.setDate(result.getDate() + days);
                        console.log(result)

                        return result;

                    }
                    function addMinutes(startDate, minutes) {

                        var result = new Date(startDate);



                        result.setMinutes(result.getMinutes() + minutes);

                        console.log(result);



                        return result;

                    }


// 使用示例

                    var startDate = new Date();

                    var jobDays = job[1]; // 假设 job[1] 是要添加的天数

                    var newStartDate = addMinutes(startDate, jobDays);


// 然后将 newStartDate 用作任务的开始日期
                    var from_to = "|F" + job[3] + '|T'+job[4]+'|'
                    tasks.push({

                        id: taskIndex++,

                        text: "J" + job[0] + from_to,

                        start_date: newStartDate,

                        duration: job[2] - job[1],

                        parent: meachine_ganttData.length+m + 1,

                        progress: 0.0,

                        open: false,

                        color: colors[(job[0] - 1) % colors.length]

                    });

                }

                var task=tasks[meachine_ganttData.length+m]

                if (task) {

                    if (total_time !== 0) {

                        // 计算 use_rate 并保留两位小数

                        task.use_rate = (use_time / total_time * 100).toFixed(2) + '%';
                        task.wait_rate= ((1-use_time / total_time) * 100).toFixed(2) + '%';

                    } else {

                        // 如果 total_time 为 0，可以设置 use_rate 为 0% 或其他默认值

                        task.use_rate = '0%';
                        task.wait_rate='0%';


                    }

                }

            }



            return tasks;

        })(),

        links: []

    });


    // Set date format
    //gantt.config.start_date = this.nowDate.format('YYYY-MM-DD')
    //gantt.config.end_date = this.newDate.format('YYYY-MM-DD')

    //    gantt.config.date_format = "%Y-%m-%d %H:%i:%s"; // Include seconds in date format
    //gantt.resize();


    // Adjust the view

    gantt.attachEvent("onGanttReady", function () {

        gantt.showDate(gantt.date.add(gantt.date.min, gantt.date.day, 1));

        gantt.showDate(gantt.date.add(gantt.date.max, gantt.date.day, 10));

    });

</script>

</body>
</html>
